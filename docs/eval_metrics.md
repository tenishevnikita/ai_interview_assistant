## –ú–µ—Ç—Ä–∏–∫–∏ –æ—Ü–µ–Ω–∫–∏ RAG —Å–∏—Å—Ç–µ–º—ã

### –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ—Ç—Ä–∏–≤–µ—Ä–∞

–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –¥–∞—Ç–∞—Å–µ—Ç—É —Å ground truth (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞).

**–ú–µ—Ç—Ä–∏–∫–∏:**
- **Recall@k**: –¥–æ–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ —Ç–æ–ø-k —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
  - –§–æ—Ä–º—É–ª–∞: (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –≤ —Ç–æ–ø-k) / (–≤—Å–µ–≥–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö)
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω–æ—Ç—É –ø–æ–∫—Ä—ã—Ç–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

- **Precision@k**: –¥–æ–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å—Ä–µ–¥–∏ —Ç–æ–ø-k —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  - –§–æ—Ä–º—É–ª–∞: (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –≤ —Ç–æ–ø-k) / k
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞

- **MRR@k** (Mean Reciprocal Rank): —Å—Ä–µ–¥–Ω—è—è –æ–±—Ä–∞—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  - –§–æ—Ä–º—É–ª–∞: 1 / (–ø–æ–∑–∏—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ)
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–µ—Ä–≤—ã–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç

- **NDCG@k** (Normalized Discounted Cumulative Gain): —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  - –£—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
  - –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ –æ—Ç 0.0 –¥–æ 1.0

**–ó–Ω–∞—á–µ–Ω–∏—è k:** 1, 3, 5, 10

**–§–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞:**
```json
{
  "retrieval": {
    "n_cases": 15,
    "avg_metrics": {
      "recall@1": 0.16,
      "precision@1": 0.2,
      "mrr@1": 0.2,
      "ndcg@1": 0.2,
      "recall@3": 0.74,
      ...
    },
    "case_results": [...]
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
make eval-retrieval
# –∏–ª–∏
uv run python -m src.eval.run_rag_eval \
  --retrieval-dataset data/validation_retrieval.jsonl \
  --index-path data/faiss_index \
  --out eval_report.json
```

**–§–æ—Ä–º–∞—Ç –¥–∞—Ç–∞—Å–µ—Ç–∞** (`data/validation_retrieval.jsonl`):
```json
{"id":"retrieval_001","question":"–ß–µ–º —Å–ø–∏—Å–∫–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –∫–æ—Ä—Ç–µ–∂–µ–π –≤ Python?","relevant_doc_ids":["chunk_066_...","chunk_084_..."],"tags":["python","data-structures"]}
```

### –ú–µ—Ç—Ä–∏–∫–∏ end-to-end

–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–ª–Ω–æ–≥–æ pipeline: rewrite ‚Üí retrieval ‚Üí answer generation.

**–ú–µ—Ç—Ä–∏–∫–∏:**

1. **Rewrite success rate** (`rewrite_contains_rate`): –¥–æ–ª—è –∫–µ–π—Å–æ–≤, –≥–¥–µ standalone-–≤–æ–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã
   - –ü—Ä–æ–≤–µ—Ä–∫–∞: AND of OR-groups (–Ω–∞–ø—Ä–∏–º–µ—Ä: ["–ø—Ä–∏–º–µ—Ä" –ò–õ–ò "–∞–ª–≥–æ—Ä–∏—Ç–º"] –ò ["–≥—Ä–∞–¥–∏–µ–Ω—Ç" –ò–õ–ò "boost"])
   - –ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0.0 –¥–æ 1.0

2. **Groundedness** (`avg_groundedness`): –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ü–∏–∏ "üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏" –≤ –æ—Ç–≤–µ—Ç–µ (1.0)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ (0.5)
   - –ï—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è (0.0)
   - –ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0.0 –¥–æ 1.0

3. **LLM-as-judge** (`avg_judge_scores`): –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–∞ –≤—Ç–æ—Ä—ã–º LLM –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
   - **Correctness** (–ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å): —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
   - **Completeness** (–ø–æ–ª–Ω–æ—Ç–∞): –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–Ω–æ –æ—Ç–≤–µ—Ç –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å
   - **Clarity** (—è—Å–Ω–æ—Å—Ç—å): –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å –∏–∑–ª–æ–∂–µ–Ω–∏—è
   - **Usefulness** (–ø–æ–ª–µ–∑–Ω–æ—Å—Ç—å): –ø–æ–ª–µ–∑–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—é
   - –ö–∞–∂–¥–∞—è –º–µ—Ç—Ä–∏–∫–∞ –æ—Ç 0.0 –¥–æ 1.0

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ —Å—Ç—Ä–æ–∫–∞—Ö –æ—Ç—á–µ—Ç–∞:**
- `rewrite_ok`: —É—Å–ø–µ—à–Ω–æ—Å—Ç—å rewrite –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–µ–π—Å–∞
- `answer_len`: –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö
- `groundedness`: groundedness –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–µ–π—Å–∞
- `judge_scores`: –æ—Ü–µ–Ω–∫–∏ LLM-as-judge –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–µ–π—Å–∞

**–§–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞:**
```json
{
  "end_to_end": {
    "n_cases": 5,
    "rewrite_contains_rate": 0.8,
    "avg_groundedness": 1.0,
    "avg_judge_scores": {
      "correctness": 0.86,
      "completeness": 0.68,
      "clarity": 0.86,
      "usefulness": 0.74
    },
    "rows": [
      {
        "id": "conv_001",
        "rewrite_ok": true,
        "answer_len": 436,
        "groundedness": 1.0,
        "judge_scores": {...}
      }
    ]
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
make eval-rag-full
# –∏–ª–∏
uv run python -m src.eval.run_rag_eval \
  --conversation-dataset data/validation_conversation.jsonl \
  --retrieval-dataset data/validation_retrieval.jsonl \
  --index-path data/faiss_index \
  --judge-model mistral-small-latest \
  --out eval_report.json
```

**–§–æ—Ä–º–∞—Ç –¥–∞—Ç–∞—Å–µ—Ç–∞** (`data/validation_conversation.jsonl`):
```json
{"id":"conv_001","history":[{"role":"user","text":"–ß—Ç–æ —Ç–∞–∫–æ–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –±—É—Å—Ç–∏–Ω–≥?"},{"role":"assistant","text":"(–ª—é–±–æ–π –æ—Ç–≤–µ—Ç)"}],"user_message":"–£—Ç–æ—á–Ω–∏ –ø—Ä–∏–º–µ—Ä—ã –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤","expected_standalone_question_groups":[["–ø—Ä–∏–º–µ—Ä","–ø—Ä–∏–º–µ—Ä—ã","–∞–ª–≥–æ—Ä–∏—Ç–º"],["–≥—Ä–∞–¥–∏–µ–Ω—Ç","boost"]],"style":"brief","tags":["followup","rewrite","ml"]}
```

### –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç

–û—Ç—á–µ—Ç –≤–∫–ª—é—á–∞–µ—Ç –æ–±–µ —Å–µ–∫—Ü–∏–∏:
```json
{
  "retrieval": {...},
  "end_to_end": {...}
}
```

–ï—Å–ª–∏ –¥–∞—Ç–∞—Å–µ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —Å–µ–∫—Ü–∏—è –±—É–¥–µ—Ç –ø—É—Å—Ç–æ–π.

### Unit —Ç–µ—Å—Ç—ã

- **Telegram constraints**: —Ç–µ—Å—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
  - `uv run pytest tests/test_formatting.py`

- **–ú–µ—Ç—Ä–∏–∫–∏**: —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫ —Ä–µ—Ç—Ä–∏–≤–µ—Ä–∞ –∏ end-to-end
  - `uv run pytest tests/test_metrics.py`

- **RAG Engine**: —Ç–µ—Å—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Ç—Ä–∏–≤–µ—Ä–æ–º
  - `uv run pytest tests/test_rag_engine.py`

- **Memory**: —Ç–µ—Å—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞
  - `uv run pytest tests/test_memory.py`

### E2E —Ç–µ—Å—Ç—ã

E2E —Ç–µ—Å—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Å–µ—Ç—å –∏ `MISTRAL_API_KEY`:
```bash
uv run pytest -m e2e
```

### –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –î–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–µ—Ç—Ä–∏–≤–µ—Ä–∞ –Ω—É–∂–µ–Ω –¥–∞—Ç–∞—Å–µ—Ç —Å ground truth (—Å–ø–∏—Å–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞)
- LLM-as-judge —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π API –≤—ã–∑–æ–≤ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Ä–æ–≥–∏–º –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
- –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ-—Ä–∞–Ω–∫–µ—Ä–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ-—Ä–∞–Ω–∫–µ—Ä–∞
