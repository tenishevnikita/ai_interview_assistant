services:
  # –°–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞)
  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –±–∏–ª–¥–µ, –µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  # –î–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ FORCE_REBUILD_INDEX=true
  data-init:
    build:
      context: .
      dockerfile: Dockerfile
    image: ai-interview-assistant:latest
    volumes:
      - ./data:/app/data
    environment:
      - PYTHONPATH=/app
      - FORCE_REBUILD_INDEX=${FORCE_REBUILD_INDEX:-false}
    command: >
      sh -c "
        if [ \"$$FORCE_REBUILD_INDEX\" = \"true\" ] || [ ! -f /app/data/faiss_index/index.faiss ]; then
          echo 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤...' &&
          python -m src.data_processing.extract_handbook &&
          python -m src.data_processing.extract_handbook_ml &&
          python -m src.data_processing.extract_handbook_cs &&
          python -m src.data_processing.extract_handbook_cpp &&
          python -m src.data_processing.extract_handbook_algo &&
          python -m src.data_processing.extract_handbook_linux &&
          python -m src.data_processing.extract_handbook_math &&
          echo 'üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ FAISS –∏–Ω–¥–µ–∫—Å–∞...' &&
          python -m src.data_processing.build_index &&
          echo '‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞!'
        else
          echo '‚úÖ –ò–Ω–¥–µ–∫—Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é'
          echo '   –î–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ FORCE_REBUILD_INDEX=true'
        fi
      "
    restart: "no"

  # –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    image: ai-interview-assistant:latest
    volumes:
      - ./data:/app/data
      - ./.env:/app/.env:ro
    environment:
      - PYTHONPATH=/app
    env_file:
      - .env
    command: python -m src.bot.main
    depends_on:
      data-init:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

